# Crash Hockey - Hockey Training Management System

A comprehensive web application for managing hockey training sessions, coaching, athlete management, billing, and accounting.

## üöÄ Quick Start

### Prerequisites
- **Web Server**: NGINX or Apache
- **PHP**: 8.1 or higher
- **MySQL/MariaDB**: 8.0 or higher
- **Node.js**: (optional, for future frontend build tools)

### Database Setup

#### 1. Create Database and User

**Login to MySQL as root:**
```bash
mysql -u root -p
```

**Create the database and user:**
```sql
-- Create the database
CREATE DATABASE crashhockey CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- Create the user (change 'your_password' to a strong password)
CREATE USER 'crashhockey'@'localhost' IDENTIFIED BY 'your_password';

-- Grant privileges
GRANT ALL PRIVILEGES ON crashhockey.* TO 'crashhockey'@'localhost';

-- Apply changes
FLUSH PRIVILEGES;

-- Exit MySQL
EXIT;
```

#### 2. Run the Setup Wizard

After creating the database and user, navigate to your application URL:

```
https://yourdomain.com/setup.php
```

The setup wizard will guide you through:
1. **Database Configuration** - Enter credentials created above
2. **Initialize Database** - Creates all tables and default data
3. **SMTP Configuration** - Configure email settings for notifications
4. **Create Admin Account** - Create the first admin user

**Important:** The setup wizard will:
- Encrypt your database credentials using AES-256
- Create all necessary tables and default permissions
- Seed age groups, skill levels, and expense categories
- Send a verification email to the admin account

### Alternative: Manual Database Import

If you prefer to manually import the schema:

```bash
mysql -u crashhockey -p crashhockey < schema.sql
```

**Note:** You'll need to manually configure:
- Database credentials in `.env` file (encrypted)
- SMTP settings in `system_settings` table
- Create the first admin user directly in the database

## üìÅ Project Structure

```
crashhockey/
‚îú‚îÄ‚îÄ setup.php                 # First-time setup wizard
‚îú‚îÄ‚îÄ index.php                 # Landing page
‚îú‚îÄ‚îÄ dashboard.php             # Main application dashboard
‚îú‚îÄ‚îÄ login.php / register.php  # Authentication
‚îú‚îÄ‚îÄ public_sessions.php       # Public session browsing
‚îÇ
‚îú‚îÄ‚îÄ views/                    # Frontend pages
‚îÇ   ‚îú‚îÄ‚îÄ drills.php           # Drill library
‚îÇ   ‚îú‚îÄ‚îÄ practice_plans.php   # Practice plan builder
‚îÇ   ‚îú‚îÄ‚îÄ packages.php         # Package purchasing
‚îÇ   ‚îú‚îÄ‚îÄ accounting.php       # Accounting dashboard
‚îÇ   ‚îú‚îÄ‚îÄ mileage_tracker.php  # Mileage tracking
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ process_*.php            # Backend processors
‚îú‚îÄ‚îÄ schema.sql              # Database schema
‚îú‚îÄ‚îÄ security.php            # Security utilities
‚îú‚îÄ‚îÄ notifications.php       # Notification system
‚îú‚îÄ‚îÄ cloud_config.php        # Nextcloud integration
‚îÇ
‚îú‚îÄ‚îÄ nginx.conf              # NGINX configuration
‚îú‚îÄ‚îÄ php-config.ini          # PHP configuration
‚îî‚îÄ‚îÄ .htaccess              # Apache configuration
```

## üîß Configuration Files

### Server Configuration
- **NGINX**: Copy `nginx.conf` to `/etc/nginx/sites-available/crashhockey`
- **PHP**: Copy `php-config.ini` to `/etc/php/8.1/fpm/conf.d/99-crashhockey.ini`
- **Apache**: Use the provided `.htaccess` file

### Environment Variables
Create a `.env` file (generated by setup wizard):
```
DB_HOST=localhost
DB_NAME=crashhockey
DB_USER=crashhockey
DB_PASS_ENCRYPTED=<encrypted_password>
ENCRYPTION_KEY=<generated_key>
```

## üìö Documentation

- **[DEPLOYMENT_GUIDE.md](DEPLOYMENT_GUIDE.md)** - Complete server deployment instructions
- **[IMPLEMENTATION_GUIDE.md](IMPLEMENTATION_GUIDE.md)** - Feature documentation and usage
- **[QUICK_START_GUIDE.md](QUICK_START_GUIDE.md)** - Package system and accounting quick start
- **[TESTING_CHECKLIST.md](TESTING_CHECKLIST.md)** - Testing procedures

## üîí Security Features

- ‚úÖ AES-256 database credential encryption
- ‚úÖ CSRF token protection on all forms
- ‚úÖ Rate limiting on authentication
- ‚úÖ Session regeneration on login
- ‚úÖ Security event logging
- ‚úÖ Content Security Policy headers
- ‚úÖ Password strength validation
- ‚úÖ Prepared statements for SQL injection prevention

## ‚öôÔ∏è Key Features

### Coaching Features
- **Drill Library** - Create and manage hockey drills with categories and tags
- **Practice Plans** - Build practice plans with drill selection and ordering
- **IHS Import** - Import drills and plans from IHS Hockey (JSON format)

### Session Management
- **Public Session Browsing** - Non-authenticated users can browse sessions
- **Session Types** - Group, Private, Semi-Private sessions
- **Age & Skill Filtering** - Sessions filtered by age group and skill level
- **Package System** - Bundled sessions or credit-based packages

### User Management
- **Multiple Roles** - Athlete, Coach, Coach+, Admin, Parent
- **Parent Accounts** - Manage multiple athletes, multi-athlete booking
- **Coach Assignment** - Assign coaches to athletes
- **Permissions System** - Modular permissions with role-based and user-specific overrides

### Accounting & Billing
- **Income Reports** - Day/week/month/year with HST breakdown
- **Per-Athlete Billing** - Itemized billing statements
- **Expense Management** - OCR receipt scanning via Nextcloud
- **Expense Categories** - Admin-managed expense categories
- **Mileage Tracking** - Google Maps integration for distance calculation
- **Refund System** - Stripe refunds, store credits, or session exchanges
- **Billing Dashboard** - Real-time income vs expense overview

### Notifications
- **In-App Notifications** - Notification center with unread badges
- **Email Notifications** - Configurable email notifications with opt-out
- **Automated Triggers** - Practice plans, workouts, video reviews, etc.

### Cloud Integration
- **Nextcloud Receipt Scanning** - Automatic OCR and expense creation
- **Google Maps API** - Distance calculation for mileage tracking
- **Stripe Payments** - Secure payment processing

## üîÑ Cron Jobs

Set up these cron jobs for automated tasks:

```bash
# Receipt scanning (every 5 minutes)
*/5 * * * * /usr/bin/php /var/www/crashhockey/cron_receipt_scanner.php

# Email notifications (every 10 minutes)
*/10 * * * * /usr/bin/php /var/www/crashhockey/cron_notifications.php
```

## üåê API Keys Required

Configure these in System Settings (Admin ‚Üí Global Settings):

1. **Stripe API Keys** - For payment processing
2. **Google Maps API Key** - For mileage distance calculations
3. **SMTP Settings** - For email notifications
4. **Nextcloud Credentials** - For cloud receipt scanning (optional)

## üìä Default Data

The setup wizard creates default data:

- **Age Groups**: Mite U8, Squirt U10, Peewee U12, Bantam U14, Midget U16, Midget U18, Junior, Adult
- **Skill Levels**: Beginner, Recreational, Intermediate, Advanced, Pro
- **Expense Categories**: Facilities, Equipment, Travel, Salaries, Marketing, Insurance, Utilities, Supplies, Technology, Professional Services
- **Permissions**: 30+ permissions across 7 categories

## üêõ Troubleshooting

### Database Connection Errors
```bash
# Check MySQL is running
sudo systemctl status mysql

# Verify credentials
mysql -u crashhockey -p crashhockey
```

### Upload Errors (Videos/Receipts)
- Check `upload_max_filesize` and `post_max_size` in `php.ini`
- Check `client_max_body_size` in NGINX config
- Verify directory permissions: `chmod 755 uploads/`

### Email Not Sending
- Verify SMTP settings in System Settings
- Check PHP mail logs: `tail -f /var/log/mail.log`
- Test SMTP connection from setup wizard

## üìù License

Copyright ¬© 2026 Crash Media IT. All rights reserved.

## üë• Support

For support, contact: support@crashmedia.it# NGINX & PHP Deployment Guide for Crash Hockey

## Directory Structure

**IMPORTANT:** This guide uses a custom `/config` directory structure:
- Web root: `/config/www/crashhockey`
- NGINX configuration: `/config/nginx/`
- PHP socket: `/config/php/php8.1-fpm.sock`
- Logs: `/config/nginx/log/`
- SSL certificates: `/config/nginx/ssl/`
- Backups: `/config/backups/crashhockey`

If your system uses standard paths (e.g., `/var/www`, `/etc/nginx`), adjust the paths accordingly throughout this guide.

---

## Prerequisites

- Ubuntu 20.04/22.04 or similar Linux distribution
- Root or sudo access
- Domain name pointed to your server

## 1. Install Required Software

```bash
# Update system packages
sudo apt update && sudo apt upgrade -y

# Install NGINX
sudo apt install nginx -y

# Install PHP 8.1 and extensions
sudo apt install php8.1-fpm php8.1-mysql php8.1-mbstring php8.1-xml php8.1-curl php8.1-zip php8.1-gd php8.1-intl php8.1-bcmath -y

# Install MySQL/MariaDB
sudo apt install mysql-server -y

# Secure MySQL installation
sudo mysql_secure_installation
```

## 2. Configure PHP for Large File Uploads

### Option A: Modify php.ini directly

```bash
# Edit PHP-FPM configuration
sudo nano /etc/php/8.1/fpm/php.ini
```

Add or modify these lines:
```ini
upload_max_filesize = 2048M
post_max_size = 2048M
memory_limit = 512M
max_execution_time = 300
max_input_time = 300
```

### Option B: Use the provided php-config.ini file

```bash
# Copy the custom PHP configuration
sudo cp php-config.ini /etc/php/8.1/fpm/conf.d/99-crashhockey.ini

# For HTTP only (development), change this line in the config:
# session.cookie_secure = 0
```

## 3. Configure PHP-FPM

Edit PHP-FPM pool configuration:

```bash
sudo nano /etc/php/8.1/fpm/pool.d/www.conf
```

Ensure these settings are present:

```ini
; Request timeout for large uploads
request_terminate_timeout = 300

; Maximum number of child processes
pm.max_children = 50
pm.start_servers = 10
pm.min_spare_servers = 5
pm.max_spare_servers = 20
```

Restart PHP-FPM:

```bash
sudo systemctl restart php8.1-fpm
```

## 4. Deploy Application Files

```bash
# Create web root directory
sudo mkdir -p /config/www/crashhockey

# Copy application files
sudo cp -r * /config/www/crashhockey/

# Set ownership (adjust user if different from www-data)
sudo chown -R www-data:www-data /config/www/crashhockey

# Set permissions
sudo find /config/www/crashhockey -type f -exec chmod 644 {} \;
sudo find /config/www/crashhockey -type d -exec chmod 755 {} \;

# Create upload directory for videos
sudo mkdir -p /config/www/crashhockey/uploads/videos
sudo chown -R www-data:www-data /config/www/crashhockey/uploads
sudo chmod -R 775 /config/www/crashhockey/uploads
```

## 5. Configure NGINX

### Copy the configuration file

```bash
# Copy Crash Hockey NGINX configuration
sudo cp nginx.conf /config/nginx/crashhockey.conf

# Edit the configuration to set your domain name
sudo nano /config/nginx/crashhockey.conf
```

Update these lines:
```nginx
server_name your-domain.com www.your-domain.com;
root /config/www/crashhockey;
```

### Create NGINX directories for large uploads and logs

```bash
# Create temporary upload directory
sudo mkdir -p /config/nginx/client_body_temp
sudo mkdir -p /config/nginx/log

# Set ownership (adjust user if different from www-data)
sudo chown -R www-data:www-data /config/nginx
sudo chmod -R 755 /config/nginx
```

### Enable the site

```bash
# Test NGINX configuration
sudo nginx -t

# If test passes, reload NGINX
sudo systemctl reload nginx
```

## 6. Configure Firewall

```bash
# Allow HTTP and HTTPS
sudo ufw allow 'Nginx Full'

# Or allow specific ports
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Enable firewall if not already enabled
sudo ufw enable
```

## 7. Run Application Setup

Navigate to your domain in a web browser:

```
http://your-domain.com/setup.php
```

Follow the 4-step setup process:
1. Database Configuration
2. Initialize Database Tables
3. SMTP Configuration (test email will be sent)
4. Create Admin Account

## 8. SSL/HTTPS Setup (Recommended for Production)

### Install Certbot for Let's Encrypt

```bash
# Install Certbot
sudo apt install certbot python3-certbot-nginx -y

# Obtain SSL certificate
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# Follow the prompts to configure automatic HTTPS redirect
```

### Manual SSL Configuration

If using a custom certificate:

1. Create SSL directory and place your certificates:
   ```bash
   sudo mkdir -p /config/nginx/ssl/your-domain.com
   # Copy your SSL certificate files to /config/nginx/ssl/your-domain.com/
   ```

2. Uncomment the SSL server block in `/config/nginx/crashhockey.conf`
3. Update certificate paths:
   ```nginx
   ssl_certificate /config/nginx/ssl/your-domain.com/fullchain.pem;
   ssl_certificate_key /config/nginx/ssl/your-domain.com/privkey.pem;
   ```
4. Test and reload NGINX:
   ```bash
   sudo nginx -t
   sudo systemctl reload nginx
   ```

### Update PHP session settings for HTTPS

After enabling SSL, update PHP configuration:

```bash
sudo nano /etc/php/8.1/fpm/conf.d/99-crashhockey.ini
```

Change:
```ini
session.cookie_secure = 1
```

Restart PHP-FPM:
```bash
sudo systemctl restart php8.1-fpm
```

## 9. Security Hardening (After Setup)

### Restrict setup.php access

After completing setup, uncomment these lines in nginx.conf:

```nginx
location = /setup.php {
    deny all;
    return 404;
}
```

Reload NGINX:
```bash
sudo systemctl reload nginx
```

### Set proper file permissions

```bash
# Restrict access to sensitive files
sudo chmod 600 /config/www/crashhockey/crashhockey.env
sudo chmod 600 /config/www/crashhockey/.setup_complete

# Ensure web server can't write to most files
sudo find /config/www/crashhockey -type f -exec chmod 644 {} \;
sudo find /config/www/crashhockey -type d -exec chmod 755 {} \;

# Exception: uploads directory needs write access
sudo chmod -R 775 /config/www/crashhockey/uploads
```

## 10. Configure Automatic Backups

### Database Backup Script

Create `/usr/local/bin/backup-crashhockey.sh`:

```bash
#!/bin/bash
BACKUP_DIR="/config/backups/crashhockey"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="crashhockey"

mkdir -p $BACKUP_DIR

# Backup database
mysqldump -u root -p$MYSQL_PASSWORD $DB_NAME | gzip > $BACKUP_DIR/db_$DATE.sql.gz

# Backup files
tar -czf $BACKUP_DIR/files_$DATE.tar.gz /config/www/crashhockey/uploads

# Keep only last 7 days of backups
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete

echo "Backup completed: $DATE"
```

Make it executable:
```bash
sudo chmod +x /usr/local/bin/backup-crashhockey.sh
```

Add to crontab (daily at 2 AM):
```bash
sudo crontab -e

# Add this line:
0 2 * * * /usr/local/bin/backup-crashhockey.sh >> /var/log/crashhockey-backup.log 2>&1
```

## 11. Monitoring and Logs

### View logs

```bash
# NGINX access log
sudo tail -f /var/log/nginx/crashhockey_access.log

# NGINX error log
sudo tail -f /var/log/nginx/crashhockey_error.log

# PHP error log
sudo tail -f /var/log/php/error.log

# PHP-FPM log
sudo tail -f /var/log/php8.1-fpm.log
```

### Monitor disk space (for video uploads)

```bash
# Check disk usage
df -h

# Check upload directory size
du -sh /config/www/crashhockey/uploads
```

## 12. Performance Optimization

### Enable OPcache

Edit `/etc/php/8.1/fpm/conf.d/10-opcache.ini`:

```ini
opcache.enable=1
opcache.memory_consumption=256
opcache.interned_strings_buffer=16
opcache.max_accelerated_files=10000
opcache.revalidate_freq=60
opcache.fast_shutdown=1
```

Restart PHP-FPM:
```bash
sudo systemctl restart php8.1-fpm
```

### Configure NGINX worker processes

Edit `/etc/nginx/nginx.conf`:

```nginx
# Set to number of CPU cores
worker_processes auto;
worker_connections 1024;
```

## Troubleshooting

### 413 Request Entity Too Large

If you still see this error:
1. Check NGINX config: `client_max_body_size 2G;`
2. Check PHP config: `upload_max_filesize` and `post_max_size`
3. Restart both services:
   ```bash
   sudo systemctl restart nginx
   sudo systemctl restart php8.1-fpm
   ```

### 504 Gateway Timeout

If uploads timeout:
1. Increase timeouts in NGINX config
2. Increase timeouts in PHP-FPM config
3. Check PHP-FPM is running: `sudo systemctl status php8.1-fpm`

### File Upload Errors

Check permissions:
```bash
sudo ls -la /config/www/crashhockey/uploads
# Should show: drwxrwxr-x www-data www-data
```

Check PHP-FPM error log:
```bash
sudo tail -f /var/log/php8.1-fpm.log
```

## Support

For issues or questions:
1. Check logs in `/var/log/nginx/` and `/var/log/php/`
2. Verify configuration with `sudo nginx -t`
3. Ensure all services are running:
   ```bash
   sudo systemctl status nginx
   sudo systemctl status php8.1-fpm
   sudo systemctl status mysql
   ```
# Crash Hockey - Feature Enhancement & Security Update

## Overview

This update implements comprehensive security enhancements, adds new coaching features (drill library and practice plan builder), implements a modular permissions system, and ensures responsive design across all pages.

## üîí Security Enhancements

### Database Setup
- **Secure Setup Page** (`setup.php`): First-time database configuration with AES-256 encryption
- **Credential Encryption**: Database passwords encrypted before storage in `.env` file
- **One-Time Setup**: Lock file prevents re-running setup after completion

### Authentication Security
- **CSRF Protection**: Tokens on all authentication forms
- **Rate Limiting**: 
  - Login: 5 attempts per 5 minutes
  - Registration: 3 attempts per 10 minutes
- **Session Security**: Session regeneration on login to prevent fixation attacks
- **Password Validation**: Minimum 8 characters with uppercase, lowercase, and number requirements
- **Email Validation**: Format checking on registration

### Security Headers
- Content Security Policy (CSP)
- X-Frame-Options: SAMEORIGIN
- X-XSS-Protection
- X-Content-Type-Options: nosniff
- Referrer-Policy: strict-origin-when-cross-origin

### Security Logging
- Complete audit trail in `security_logs` table
- Logs authentication events, permission changes, imports
- Tracks IP address and user agent

## üèí New Features

### 1. Drill Library
**Location**: Dashboard ‚Üí Drill Library

Features:
- Create, edit, and delete hockey drills
- Categorize drills (admin-only category creation)
- Search and filter by:
  - Category
  - Skill level (beginner, intermediate, advanced)
  - Keywords in title/description
- Tag system for organization
- Duration tracking
- Equipment lists
- Coaching points
- Video URL support
- IHS import tracking

**Permissions**:
- `view_drills`: View drill library
- `create_drills`: Create and edit drills
- `delete_drills`: Delete drills
- `manage_drill_categories`: Create and manage categories (admin only)

### 2. Practice Plan Builder
**Location**: Dashboard ‚Üí Practice Plans

Features:
- Create complete practice plans
- Add multiple drills to plans
- Set duration for each drill
- Reorder drills with up/down arrows
- Age group and focus area tags
- Public/private visibility
- **Shareable Links**: Generate unique URLs to share plans
- Import from IHS Hockey format

**Permissions**:
- `view_practice_plans`: View practice plans
- `create_practice_plans`: Create practice plans
- `share_practice_plans`: Generate shareable links
- `delete_practice_plans`: Delete practice plans

### 3. IHS Import
**Location**: Dashboard ‚Üí Coach Management ‚Üí IHS Import

Import drills and practice plans from IHS Hockey JSON format.

Features:
- Import individual drills or complete practice plans
- Preview before import
- Auto-categorization option
- Duplicate detection (skip or overwrite)
- Create missing drills when importing plans
- Import history tracking

**Permissions**:
- `import_from_ihs`: Access IHS import interface

**Sample JSON Format**:
```json
{
  "drills": [
    {
      "title": "2-on-1 Rush Drill",
      "description": "Offensive rush focusing on decision making",
      "duration": 15,
      "skill_level": "intermediate",
      "equipment": "Cones, pucks",
      "coaching_points": "Keep head up, support puck carrier"
    }
  ]
}
```

### 4. Permissions Management
**Location**: Dashboard ‚Üí System Admin ‚Üí Permissions (Admin Only)

Modular permission system with 30+ granular permissions across 7 categories:
- General (dashboard, stats)
- Schedule (booking, cancellations)
- Training (workouts, assignments)
- Nutrition (plans, assignments)
- Media (videos, uploads)
- Drills (library, categories)
- Practice (plans, sharing)
- Integration (IHS imports)
- Management (athletes, notes)
- Admin (system settings, roles)

**Two-Level System**:
1. **Role Permissions**: Default permissions for each role
2. **User Overrides**: Individual permission grants/revokes

**Roles**:
- **Athlete**: View own stats, book sessions, view assignments
- **Coach**: All athlete permissions + create workouts, nutrition plans, manage athletes
- **Coach+**: All coach permissions + session management, IHS imports, extended media access
- **Admin**: All permissions

## üì± Responsive Design

### Dashboard
- Mobile menu toggle button (hamburger icon)
- Sidebar collapses on mobile (< 768px)
- Overlay when menu is open
- Touch-friendly navigation

### Breakpoints
- **Desktop**: 1024px+
- **Tablet**: 768px - 1023px
- **Mobile**: < 768px

### Design Consistency
- Orange accent color: `#ff4d00`
- Dark theme: `#06080b` background, `#0d1117` cards
- Consistent spacing and typography
- Mobile-optimized forms and buttons

## üóÑÔ∏è Database Schema

### New Tables

1. **drills** - Hockey drill library
2. **drill_categories** - Drill organization
3. **drill_tags** - Tag system for drills
4. **practice_plans** - Practice plan definitions
5. **practice_plan_drills** - Drills in each plan
6. **practice_plan_shares** - Share link tracking
7. **permissions** - Available permissions
8. **role_permissions** - Default role permissions
9. **user_permissions** - User-specific overrides
10. **security_logs** - Security event audit trail

### Modified Tables
- **users**: Added `coach_plus` to role enum

## üöÄ Getting Started

### Initial Setup

1. **Database Setup** (First Time Only):
   ```
   Navigate to: https://yourdomain.com/setup.php
   ```
   - Enter database credentials
   - Create encryption key (32+ characters)
   - Initialize database tables
   - **Important**: Store encryption key securely!

2. **Create Admin Account**:
   ```
   Navigate to: https://yourdomain.com/register.php
   ```
   - Register first account
   - Manually set role to 'admin' in database:
   ```sql
   UPDATE users SET role = 'admin' WHERE email = 'your@email.com';
   ```

3. **Configure Permissions** (Optional):
   - Login as admin
   - Go to Dashboard ‚Üí System Admin ‚Üí Permissions
   - Customize role permissions as needed

### Environment File

After setup, `crashhockey.env` will contain:
```env
DB_HOST=localhost
DB_NAME=crashhockey
DB_USER=your_user
DB_PASS_ENCRYPTED=<encrypted_password>
ENCRYPTION_KEY_HASH=<key_hash>
```

**Security**: Keep this file secure and outside web root if possible.

## üìã Usage Examples

### Creating a Drill

1. Navigate to Dashboard ‚Üí Drill Library
2. Click "Create Drill"
3. Fill in drill details:
   - Title (required)
   - Category
   - Description
   - Duration
   - Skill level
   - Equipment needed
   - Coaching points
4. Click "Save Drill"

### Building a Practice Plan

1. Navigate to Dashboard ‚Üí Practice Plans
2. Click "Create Plan"
3. Fill in plan details:
   - Title (required)
   - Description
   - Total duration
   - Age group
   - Focus area
4. Add drills:
   - Search for existing drills
   - Click "Add to Plan"
   - Set duration for each drill
   - Reorder with arrows
5. Click "Save Plan"

### Sharing a Practice Plan

1. View practice plan
2. Click "Share" button
3. Click "Generate Share Link"
4. Copy and share URL
5. Recipients can view plan without login

### Importing from IHS

1. Navigate to Dashboard ‚Üí IHS Import
2. Paste JSON data
3. Click "Preview" to verify
4. Select import options
5. Click "Import"

## üîß Configuration

### Security Settings

**Rate Limiting** (in `security.php`):
```php
isRateLimited('login', 5, 300)  // 5 attempts per 5 minutes
isRateLimited('register', 3, 600)  // 3 attempts per 10 minutes
```

**Session Settings** (recommended in `php.ini`):
```ini
session.cookie_httponly = 1
session.cookie_secure = 1  # If using HTTPS
session.use_strict_mode = 1
```

### HTTPS (Recommended)

Uncomment in `security.php` when using HTTPS:
```php
header('Strict-Transport-Security: max-age=31536000; includeSubDomains');
```

Update CSP to require HTTPS:
```php
header("upgrade-insecure-requests");
```

## üêõ Troubleshooting

### Database Connection Failed
- Verify credentials in `crashhockey.env`
- Check MySQL service is running
- Ensure database exists
- Verify user has proper permissions

### CSRF Token Validation Failed
- Session may have expired - refresh page
- Clear browser cookies
- Check session settings in `php.ini`

### Rate Limit Exceeded
- Wait 5-10 minutes before retrying
- Clear session data if persistent
- Check `security_logs` table for details

### Permission Denied Errors
- Verify user role in database
- Check role permissions in admin panel
- Clear any user-specific overrides

### Import Fails
- Verify JSON format is correct
- Check for required fields (title)
- Review error message details
- Ensure drills exist for practice plans

## üìä Monitoring

### Security Logs

Query security events:
```sql
SELECT * FROM security_logs 
WHERE event_type = 'login_failed' 
ORDER BY created_at DESC 
LIMIT 50;
```

Monitor rate limiting:
```sql
SELECT * FROM security_logs 
WHERE event_type = 'rate_limit_exceeded' 
AND created_at > DATE_SUB(NOW(), INTERVAL 1 HOUR);
```

### Import History

View recent IHS imports:
```sql
SELECT type, title, created_at 
FROM (
    SELECT 'drill' as type, title, created_at 
    FROM drills WHERE imported_from_ihs = 1
    UNION ALL
    SELECT 'plan' as type, title, created_at 
    FROM practice_plans WHERE imported_from_ihs = 1
) AS imports
ORDER BY created_at DESC
LIMIT 20;
```

## üîê Security Best Practices

1. **Encryption Key**: Store securely, never commit to version control
2. **HTTPS**: Use SSL/TLS in production
3. **Backups**: Regular database backups
4. **Updates**: Keep PHP and MySQL updated
5. **Permissions**: Review user permissions regularly
6. **Logs**: Monitor security logs for suspicious activity
7. **Rate Limits**: Adjust based on legitimate usage patterns

## üìû Support

For issues or questions:
1. Check this documentation
2. Review error messages in browser console
3. Check `security_logs` table for details
4. Verify file permissions are correct

## üéØ Roadmap

Future enhancements:
- [ ] XML format support for IHS imports
- [ ] AJAX-based drill and plan editing
- [ ] Drill diagram designer with canvas
- [ ] Practice plan templates
- [ ] Email notifications for shared plans
- [ ] Mobile app integration
- [ ] Video upload and hosting
- [ ] Advanced analytics and reporting

## üìù License

Copyright ¬© 2026 Crash Hockey Development. All Rights Reserved.

---

**Version**: 2.0.0  
**Last Updated**: January 19, 2026  
**Author**: Crash Media IT
# Crash Hockey - Quick Start Guide
## Package System & Accounting Features

---

## Table of Contents
1. [Package System Setup](#1-package-system-setup)
2. [Using Packages as a Customer](#2-using-packages-as-a-customer)
3. [Accounting Setup](#3-accounting-setup)
4. [Daily Accounting Tasks](#4-daily-accounting-tasks)
5. [Monthly Reporting](#5-monthly-reporting)
6. [Troubleshooting](#6-troubleshooting)

---

## 1. Package System Setup

### Step 1: Create Your First Credit Package
1. Login as **Admin**
2. Click **System Admin ‚Üí Packages**
3. Click **"+ Create Package"**
4. Fill in the form:
   - **Name:** "10 Session Credit Pack"
   - **Type:** Credit Package
   - **Price:** 450.00
   - **Credits:** 10
   - **Valid for:** 365 days
   - **Age Group:** (optional) Select if age-specific
   - **Skill Level:** (optional) Select if skill-specific
   - **Active:** ‚úì Checked
5. Click **"Save Package"**

**Result:** Customers now see this package and can purchase it. They'll get 10 credits valid for 1 year.

---

### Step 2: Create Your First Bundled Package
1. First, create some upcoming sessions:
   - Navigate to **Coach Management ‚Üí Create Session**
   - Create 3-5 sessions for next month
   
2. Go back to **System Admin ‚Üí Packages**
3. Click **"+ Create Package"**
4. Fill in the form:
   - **Name:** "February Skills Series"
   - **Type:** Bundled Package
   - **Price:** 275.00
   - **Valid for:** 365 days
   - **Active:** ‚úì Checked
5. Click **"Save Package"**

6. Find your new package in the table
7. Click the **list icon** (üìã) next to it
8. Check the boxes for the 3-5 sessions you created
9. Click **"Update Sessions"**

**Result:** Customers can now purchase this bundle and will be automatically enrolled in all selected sessions.

---

## 2. Using Packages as a Customer

### Purchasing a Package

1. Login as **Athlete** or **Parent**
2. Click **Account & History ‚Üí Session Packages**
3. Browse available packages
4. Use filter buttons to show only Credits or Bundled
5. Click **"Purchase Package"**
6. If you're a parent, select which athletes to purchase for
7. Click **"Purchase Package"** again
8. You'll be redirected to Stripe checkout
9. Enter test card: `4242 4242 4242 4242`, any future date, any CVV
10. Complete payment

**Result:** You'll return to the dashboard with a success message. Credits will appear in your account.

---

### Using Credits

1. After purchasing credits, go to **Book Sessions**
2. Find a session and click **"Book"**
3. If you have available credits:
   - No payment screen will appear
   - Credit is automatically used
   - You'll see "Booked with Package Credit" message
4. If you don't have credits:
   - Regular Stripe checkout appears
   - Pay for individual session

**Result:** Your session is booked and your credit balance decreases by 1.

---

### Checking Your Credits

1. Go to **Account & History ‚Üí Session Packages**
2. Top section shows **"Your Active Credits"**
3. For each package you've purchased:
   - See credits remaining
   - See expiration date
4. Expired credits won't be used automatically

---

## 3. Accounting Setup

### Step 1: Create Expense Categories

Before tracking expenses, set up categories:

1. Login as **Admin**
2. Navigate to **Accounting & Reports ‚Üí Expense Categories**
3. Create these essential categories:
   - **Ice Time** (display order: 1)
   - **Equipment** (display order: 2)
   - **Staff Wages** (display order: 3)
   - **Marketing** (display order: 4)
   - **Travel** (display order: 5)
   - **Utilities** (display order: 6)
   - **Insurance** (display order: 7)
   - **Other** (display order: 99)

**Tip:** Lower display order = shows first in dropdowns

---

### Step 2: Configure Tax Settings

Ensure your tax settings are correct:

1. Go to **System Admin ‚Üí Global Settings**
2. Find **Tax Settings** section
3. Set:
   - **Tax Rate:** 13.00 (for 13% HST)
   - **Tax Name:** HST (or GST/VAT as appropriate)
4. Save changes

**Result:** All income and expense reports will correctly calculate tax.

---

## 4. Daily Accounting Tasks

### Recording an Expense

1. Navigate to **Accounting & Reports ‚Üí Expenses**
2. Click **"Add Expense"**
3. Fill in the form:
   - **Vendor Name:** "City Arena"
   - **Expense Date:** Select date (usually today)
   - **Category:** Select "Ice Time"
   - **Amount:** 200.00 (before tax)
   - **Tax Amount:** 26.00 (if applicable)
   - **Total Amount:** 226.00 (auto-calculated)
   - **Payment Method:** Credit Card
   - **Reference Number:** Invoice #12345 (optional)
   - **Description:** "Friday evening ice rental"
   - **Upload Receipt:** Choose file (JPG, PNG, or PDF)
4. Click **"Save Expense"**

**Result:** Expense is recorded and will appear in reports.

---

### Viewing Daily Income

1. Go to **Accounting & Reports ‚Üí Income Reports**
2. Select filter: **"Today"**
3. View all bookings for today:
   - Customer names
   - What they purchased
   - Amounts (subtotal, tax, total)
   - Payment IDs

**Tip:** Keep this page open to monitor daily revenue in real-time.

---

## 5. Monthly Reporting

### Month-End Income Report

1. Navigate to **Accounting & Reports ‚Üí Income Reports**
2. Set filter to **"This Month"**
3. Review the summary:
   - Total bookings this month
   - Gross revenue (subtotal)
   - Tax collected
   - Total revenue
4. Click **"Export CSV"** to download
5. Open in Excel/Google Sheets for further analysis

---

### Month-End Expense Report

1. Navigate to **Accounting & Reports ‚Üí Expenses**
2. Scroll through expenses for the month
3. Verify all expenses are recorded
4. Check all receipts are uploaded
5. Total expenses shown at top

---

### Profit & Loss Statement

1. Go to **Accounting & Reports ‚Üí Dashboard**
2. Select current year
3. Review the 3 summary cards:
   - **Total Income:** All revenue for the year
   - **Total Expenses:** All costs for the year
   - **Net Profit:** Income minus Expenses
4. Check the **Monthly Overview** chart:
   - Blue line = Income
   - Red line = Expenses
   - Gap between = Profit or Loss
5. Review profit margin percentage

**Action:** If profit margin is low, consider:
- Increasing session prices
- Creating package deals
- Reducing controllable expenses
- Offering premium private sessions

---

### Per-Athlete Billing

Use this for transparency or collections:

1. Go to **Accounting & Reports ‚Üí Athlete Billing**
2. Select current year
3. See all athletes with their total spending
4. Click on any athlete to see itemized list:
   - Every session booked
   - Every package purchased
   - Dates and amounts
5. Click **"Export Report"** to print/PDF
6. Send to athlete or parent if requested

---

## 6. Troubleshooting

### Problem: Package Credits Not Appearing After Purchase

**Check:**
1. Was payment successful? Check payment_history
2. Is package active? Check admin_packages
3. Are credits expired? Check expiry_date
4. Clear browser cache and refresh

**Fix:** Admin can manually add credits in database if needed

---

### Problem: Credits Not Being Used When Booking

**Check:**
1. Does athlete have credits? Check packages page
2. Are credits expired?
3. Is the session eligible for credit use?

**Fix:** Customer should see "Booked with Package Credit" if credits were used. If charged, check for available credits at time of booking.

---

### Problem: Income Totals Don't Match Bank Deposits

**Check:**
1. Stripe fees are deducted by Stripe (not shown in reports)
2. Refunds/cancellations may not be processed yet
3. Check payment_status in bookings table
4. Some bookings may be pending

**Fix:** 
- Export income report for date range
- Compare with Stripe dashboard
- Account for Stripe's 2.9% + $0.30 per transaction fee

---

### Problem: Can't Delete Expense Category

**Reason:** Category is being used by existing expenses

**Fix:**
1. Go to Expenses
2. Find all expenses using that category
3. Either delete those expenses OR
4. Change them to a different category
5. Then delete the category

---

### Problem: Receipt Upload Fails

**Check:**
1. File size (max 10MB recommended)
2. File type (only JPG, PNG, PDF allowed)
3. File permissions on uploads/receipts/ folder
4. Disk space on server

**Fix:**
- Compress large images before uploading
- Convert other formats to JPG/PNG/PDF
- Contact hosting provider if disk full

---

### Problem: Dashboard Shows $0 for Everything

**Check:**
1. Are there any paid bookings? Check session_history
2. Is correct year selected?
3. Database connection working?

**Fix:**
- Make a test booking to verify system is recording income
- Verify year selector is set correctly
- Check database credentials in db_config.php

---

## Best Practices

### Daily
- ‚úÖ Record expenses same day they occur
- ‚úÖ Upload all receipts immediately
- ‚úÖ Monitor daily income report

### Weekly
- ‚úÖ Review new bookings
- ‚úÖ Check credit package sales
- ‚úÖ Verify all expenses categorized correctly

### Monthly
- ‚úÖ Export income report for records
- ‚úÖ Reconcile with bank statements
- ‚úÖ Review profit margins
- ‚úÖ Plan next month's sessions

### Quarterly
- ‚úÖ Review package pricing and popularity
- ‚úÖ Analyze expense trends
- ‚úÖ Create financial projections
- ‚úÖ Adjust pricing if needed

### Yearly
- ‚úÖ Export full year income report for taxes
- ‚úÖ Export full year expense report for taxes
- ‚úÖ Review year-over-year growth
- ‚úÖ Set goals for next year

---

## Tips for Success

1. **Create Package Incentives**
   - Price packages at 10-15% discount vs individual sessions
   - Offer early-bird package deals
   - Create seasonal packages

2. **Expense Management**
   - Photograph receipts immediately
   - Store physical receipts in labeled folders
   - Review expenses monthly to find savings
   - Negotiate bulk rates with arenas

3. **Customer Communication**
   - Email customers when new packages launch
   - Remind customers of expiring credits
   - Send monthly billing statements
   - Offer package upgrades

4. **Financial Planning**
   - Set aside 30% of income for taxes
   - Build emergency fund (3 months expenses)
   - Reinvest 10-20% in marketing/equipment
   - Monitor cash flow weekly

---

## Support

Need help?
- Check IMPLEMENTATION_SUMMARY.md for technical details
- Review TESTING_CHECKLIST.md for verification steps
- Check system logs for error messages
- Contact your developer for custom support

---

**Version:** 1.0  
**Last Updated:** 2024  
**For:** Crash Hockey Application
