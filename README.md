# Crash Hockey - Hockey Training Management System

A comprehensive web application for managing hockey training sessions, coaching, athlete management, billing, and accounting.

## üöÄ Quick Start

### Prerequisites
- **Web Server**: NGINX or Apache
- **PHP**: 8.1 or higher
- **MySQL/MariaDB**: 8.0 or higher
- **Node.js**: (optional, for future frontend build tools)

### Database Setup

#### 1. Create Database and User

**Login to MySQL as root:**
```bash
mysql -u root -p
```

**Create the database and user:**
```sql
-- Create the database
CREATE DATABASE crashhockey CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- Create the user (change 'your_password' to a strong password)
CREATE USER 'crashhockey'@'localhost' IDENTIFIED BY 'your_password';

-- Grant privileges
GRANT ALL PRIVILEGES ON crashhockey.* TO 'crashhockey'@'localhost';

-- Apply changes
FLUSH PRIVILEGES;

-- Exit MySQL
EXIT;
```

#### 2. Run the Setup Wizard

After creating the database and user, navigate to your application URL:

```
https://yourdomain.com/setup.php
```

The setup wizard will guide you through:
1. **Database Configuration** - Enter credentials created above
2. **Initialize Database** - Creates all tables and default data
3. **SMTP Configuration** - Configure email settings for notifications
4. **Create Admin Account** - Create the first admin user

**Important:** The setup wizard will:
- Encrypt your database credentials using AES-256
- Create all necessary tables and default permissions
- Seed age groups, skill levels, and expense categories
- Send a verification email to the admin account

### Alternative: Manual Database Import

If you prefer to manually import the schema:

```bash
mysql -u crashhockey -p crashhockey < schema.sql
```

**Note:** You'll need to manually configure:
- Database credentials in `.env` file (encrypted)
- SMTP settings in `system_settings` table
- Create the first admin user directly in the database

## üìÅ Project Structure

```
crashhockey/
‚îú‚îÄ‚îÄ setup.php                 # First-time setup wizard
‚îú‚îÄ‚îÄ index.php                 # Landing page
‚îú‚îÄ‚îÄ dashboard.php             # Main application dashboard
‚îú‚îÄ‚îÄ login.php / register.php  # Authentication
‚îú‚îÄ‚îÄ public_sessions.php       # Public session browsing
‚îÇ
‚îú‚îÄ‚îÄ views/                    # Frontend pages
‚îÇ   ‚îú‚îÄ‚îÄ drills.php           # Drill library
‚îÇ   ‚îú‚îÄ‚îÄ practice_plans.php   # Practice plan builder
‚îÇ   ‚îú‚îÄ‚îÄ packages.php         # Package purchasing
‚îÇ   ‚îú‚îÄ‚îÄ accounting.php       # Accounting dashboard
‚îÇ   ‚îú‚îÄ‚îÄ mileage_tracker.php  # Mileage tracking
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ process_*.php            # Backend processors
‚îú‚îÄ‚îÄ schema.sql              # Database schema
‚îú‚îÄ‚îÄ security.php            # Security utilities
‚îú‚îÄ‚îÄ notifications.php       # Notification system
‚îú‚îÄ‚îÄ cloud_config.php        # Nextcloud integration
‚îÇ
‚îú‚îÄ‚îÄ nginx.conf              # NGINX configuration
‚îú‚îÄ‚îÄ php-config.ini          # PHP configuration
‚îî‚îÄ‚îÄ .htaccess              # Apache configuration
```

## üîß Configuration Files

### Server Configuration
- **NGINX**: Copy `nginx.conf` to `/etc/nginx/sites-available/crashhockey`
- **PHP**: Copy `php-config.ini` to `/etc/php/8.1/fpm/conf.d/99-crashhockey.ini`
- **Apache**: Use the provided `.htaccess` file

### Environment Variables
Create a `.env` file (generated by setup wizard):
```
DB_HOST=localhost
DB_NAME=crashhockey
DB_USER=crashhockey
DB_PASS_ENCRYPTED=<encrypted_password>
ENCRYPTION_KEY=<generated_key>
```

## üìö Documentation

- **[DEPLOYMENT_GUIDE.md](DEPLOYMENT_GUIDE.md)** - Complete server deployment instructions
- **[IMPLEMENTATION_GUIDE.md](IMPLEMENTATION_GUIDE.md)** - Feature documentation and usage
- **[QUICK_START_GUIDE.md](QUICK_START_GUIDE.md)** - Package system and accounting quick start
- **[TESTING_CHECKLIST.md](TESTING_CHECKLIST.md)** - Testing procedures

## üîí Security Features

- ‚úÖ AES-256 database credential encryption
- ‚úÖ CSRF token protection on all forms
- ‚úÖ Rate limiting on authentication
- ‚úÖ Session regeneration on login
- ‚úÖ Security event logging
- ‚úÖ Content Security Policy headers
- ‚úÖ Password strength validation
- ‚úÖ Prepared statements for SQL injection prevention

## ‚öôÔ∏è Key Features

### Coaching Features
- **Drill Library** - Create and manage hockey drills with categories and tags
- **Practice Plans** - Build practice plans with drill selection and ordering
- **IHS Import** - Import drills and plans from IHS Hockey (JSON format)

### Session Management
- **Public Session Browsing** - Non-authenticated users can browse sessions
- **Session Types** - Group, Private, Semi-Private sessions
- **Age & Skill Filtering** - Sessions filtered by age group and skill level
- **Package System** - Bundled sessions or credit-based packages

### User Management
- **Multiple Roles** - Athlete, Coach, Coach+, Admin, Parent
- **Parent Accounts** - Manage multiple athletes, multi-athlete booking
- **Coach Assignment** - Assign coaches to athletes
- **Permissions System** - Modular permissions with role-based and user-specific overrides

### Accounting & Billing
- **Income Reports** - Day/week/month/year with HST breakdown
- **Per-Athlete Billing** - Itemized billing statements
- **Expense Management** - OCR receipt scanning via Nextcloud
- **Expense Categories** - Admin-managed expense categories
- **Mileage Tracking** - Google Maps integration for distance calculation
- **Refund System** - Stripe refunds, store credits, or session exchanges
- **Billing Dashboard** - Real-time income vs expense overview

### Notifications
- **In-App Notifications** - Notification center with unread badges
- **Email Notifications** - Configurable email notifications with opt-out
- **Automated Triggers** - Practice plans, workouts, video reviews, etc.

### Cloud Integration
- **Nextcloud Receipt Scanning** - Automatic OCR and expense creation
- **Google Maps API** - Distance calculation for mileage tracking
- **Stripe Payments** - Secure payment processing

## üîÑ Cron Jobs

Set up these cron jobs for automated tasks:

```bash
# Receipt scanning (every 5 minutes)
*/5 * * * * /usr/bin/php /var/www/crashhockey/cron_receipt_scanner.php

# Email notifications (every 10 minutes)
*/10 * * * * /usr/bin/php /var/www/crashhockey/cron_notifications.php
```

## üåê API Keys Required

Configure these in System Settings (Admin ‚Üí Global Settings):

1. **Stripe API Keys** - For payment processing
2. **Google Maps API Key** - For mileage distance calculations
3. **SMTP Settings** - For email notifications
4. **Nextcloud Credentials** - For cloud receipt scanning (optional)

## üìä Default Data

The setup wizard creates default data:

- **Age Groups**: Mite U8, Squirt U10, Peewee U12, Bantam U14, Midget U16, Midget U18, Junior, Adult
- **Skill Levels**: Beginner, Recreational, Intermediate, Advanced, Pro
- **Expense Categories**: Facilities, Equipment, Travel, Salaries, Marketing, Insurance, Utilities, Supplies, Technology, Professional Services
- **Permissions**: 30+ permissions across 7 categories

## üêõ Troubleshooting

### Database Connection Errors
```bash
# Check MySQL is running
sudo systemctl status mysql

# Verify credentials
mysql -u crashhockey -p crashhockey
```

### Upload Errors (Videos/Receipts)
- Check `upload_max_filesize` and `post_max_size` in `php.ini`
- Check `client_max_body_size` in NGINX config
- Verify directory permissions: `chmod 755 uploads/`

### Email Not Sending
- Verify SMTP settings in System Settings
- Check PHP mail logs: `tail -f /var/log/mail.log`
- Test SMTP connection from setup wizard

## üìù License

Copyright ¬© 2026 Crash Media IT. All rights reserved.

## üë• Support

For support, contact: support@crashmedia.it